# å¯è§‚æµ‹æ€§

## æ¦‚è¿°

agix æä¾›å…¨é¢çš„å¯è§‚æµ‹æ€§æ¥ç›‘æ§æ€§èƒ½ã€è°ƒè¯•é—®é¢˜å’Œè¿½è¸ªå®‰å…¨äº‹ä»¶ï¼š

- **è¯·æ±‚è¿½è¸ª** â€” è¯¦ç»†çš„é€æ®µä¿¡æ¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰ç®¡é“æ­¥éª¤
- **å®¡è®¡æ—¥å¿—** â€” å¸¦æœ‰å¯é€‰å†…å®¹æ•è·çš„å®‰å…¨äº‹ä»¶æ—¥å¿—
- **å¥åº·æ£€æŸ¥** â€” `agix doctor` å‘½ä»¤æ¥è¯Šæ–­é…ç½®å’Œè¿æ¥æ€§
- **æŒ‡æ ‡ä»ªè¡¨æ¿** â€” æˆæœ¬å¯è§†åŒ–å’Œé¢„ç®—ç›‘æ§çš„ Web UI

## è¯·æ±‚è¿½è¸ª

è¯·æ±‚è¿½è¸ªæä¾›é€šè¿‡ä»£ç†æµåŠ¨çš„æ¯ä¸ªè¯·æ±‚çš„è¯¦ç»†è®¡æ—¶å’Œè¯Šæ–­ã€‚

### å·¥ä½œåŸç†

æ¯ä¸ªè¯·æ±‚éƒ½æ¥æ”¶ä¸€ä¸ª `Trace-ID` å¹¶ç”Ÿæˆå¤šä¸ª spanï¼š

1. è¯·æ±‚åˆ°è¾¾ â†’ åˆ›å»ºæ ¹ span
2. ç®¡é“ä¸­çš„æ¯ä¸€æ­¥éƒ½åˆ›å»ºä¸€ä¸ªå­ spanï¼š
   - é¢„ç®—æ£€æŸ¥
   - é˜²ç«å¢™æ‰«æ
   - æç¤ºè¯æ¨¡æ¿æ³¨å…¥
   - ç¼“å­˜æŸ¥æ‰¾
   - è·¯ç”±å™¨åˆ†æ
   - æä¾›å•† API è°ƒç”¨
   - Token è®¡æ•°
   - æˆæœ¬è®¡ç®—
   - å“åº”ç­–ç•¥
   - æ•°æ®åº“å†™å…¥
3. æ‰€æœ‰ span éƒ½åœ¨è¿½è¸ª ID ä¸‹æ”¶é›†
4. è¿½è¸ªå¯ä¾›æ£€æŸ¥

### æŸ¥çœ‹è¿½è¸ª

```bash
# åˆ—å‡ºæœ€è¿‘çš„è¿½è¸ª
agix trace list

# æŸ¥çœ‹å¸¦æœ‰æ‰€æœ‰ span çš„è¯¦ç»†è¿½è¸ª
agix trace abc-123

# æŒ‰ Agent è¿‡æ»¤
agix trace list --agent code-reviewer
```

ç¤ºä¾‹è¾“å‡ºï¼š

```
è¿½è¸ª IDï¼štrace-abc-123
çŠ¶æ€ï¼šSUCCESS
æ—¶é•¿ï¼š1250ms
è¯·æ±‚ï¼šgpt-4oï¼Œ250 è¾“å…¥ tokens

Spanï¼š
â”œâ”€ proxy.request (1250ms)
â”‚  â”œâ”€ budget.check (5ms)
â”‚  â”œâ”€ firewall.scan (15ms)
â”‚  â”œâ”€ cache.lookup (20ms)
â”‚  â”œâ”€ router.classify (10ms)
â”‚  â”œâ”€ api.call (1000ms)
â”‚  â”‚  â””â”€ openai.chat.completions
â”‚  â”œâ”€ extraction.tokencount (15ms)
â”‚  â”œâ”€ cost.calculate (5ms)
â”‚  â”œâ”€ policy.apply (10ms)
â”‚  â””â”€ store.write (50ms)

æˆæœ¬ï¼š$0.015
```

### å“åº”è¯·æ±‚å¤´

æ¯ä¸ªå“åº”éƒ½åŒ…å«è¿½è¸ª IDï¼š

```
X-Trace-ID: trace-abc-123
```

ä¿å­˜æ­¤ä»¥å…³è”åˆ°åç«¯æ—¥å¿—ã€‚

### è¿½è¸ªé…ç½®

```yaml
tracing:
  enabled: true
  sample_rate: 1.0                 # 0-1ï¼Œé»˜è®¤è®°å½•æ‰€æœ‰

  # sample_rate ç¤ºä¾‹ï¼š
  # 1.0 = è®°å½•æ‰€æœ‰è¯·æ±‚ï¼ˆè¯¦ç»†ï¼Œé«˜ç£ç›˜ä½¿ç”¨ï¼‰
  # 0.5 = è®°å½• 50% çš„è¯·æ±‚ï¼ˆå‡è¡¡ï¼‰
  # 0.1 = è®°å½• 10% çš„è¯·æ±‚ï¼ˆæ€§èƒ½ï¼Œé‡‡æ ·ï¼‰
  # 0.0 = ç¦ç”¨è¿½è¸ª
```

### ç”¨ä¾‹ï¼šè°ƒè¯•æ…¢è¯·æ±‚

```bash
# è¯†åˆ«æ…¢è¿½è¸ª
agix trace list | grep "Duration: [2-9][0-9][0-9][0-9]ms"

# æŸ¥çœ‹è¯¦ç»† span åˆ†æ
agix trace trace-slow-123

# æ£€æŸ¥å“ªä¸ª span æ˜¯ç“¶é¢ˆï¼š
# å¦‚æœ api.call > 1000ms â†’ ä¸Šæ¸¸æä¾›å•†å¾ˆæ…¢
# å¦‚æœ cache.lookup > 100ms â†’ æ•°æ®åº“é—®é¢˜
# å¦‚æœ firewall.scan > 100ms â†’ æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½é—®é¢˜
```

## å®¡è®¡æ—¥å¿—

å®¡è®¡æ—¥å¿—è¿½è¸ªå®‰å…¨äº‹ä»¶ï¼šå·¥å…·è°ƒç”¨ã€é˜²ç«å¢™é˜»æ­¢ã€ç­–ç•¥åº”ç”¨ã€èº«ä»½éªŒè¯ã€‚

### å·¥ä½œåŸç†

1. å‘ç”Ÿå®‰å…¨ç›¸å…³äº‹ä»¶ï¼ˆå·¥å…·è°ƒç”¨ã€é˜»æ­¢ã€è„±æ•ï¼‰
2. äº‹ä»¶ä»¥ä»¥ä¸‹å†…å®¹è®°å½•ï¼š
   - æ—¶é—´æˆ³
   - Agent åç§°
   - äº‹ä»¶ç±»å‹
   - è¯¦æƒ…ï¼ˆå·¥å…·åã€é˜»æ­¢åŸå› ç­‰ï¼‰
   - å¯é€‰å†…å®¹ï¼ˆå¦‚æœå¯ç”¨ï¼Œè¯·æ±‚/å“åº”ï¼‰
3. æ—¥å¿—æŒä¹…åŒ–åˆ°æ•°æ®åº“

### é…ç½®

```yaml
audit:
  enabled: true
  content_log: true                # è®°å½•å®Œæ•´çš„è¯·æ±‚/å“åº”æ­£æ–‡

  # å°†é«˜é£é™©å·¥å…·æ ‡è®°ä¸ºå±é™©
  dangerous_tools: ["delete_file", "execute_cmd", "modify_permissions"]
```

### æŸ¥çœ‹å®¡è®¡äº‹ä»¶

```bash
# åˆ—å‡ºå®‰å…¨äº‹ä»¶
agix audit list

# æŒ‰äº‹ä»¶ç±»å‹è¿‡æ»¤
agix audit list --type tool_call
agix audit list --type firewall_block
agix audit list --type response_redaction

# æŒ‰ Agent è¿‡æ»¤
agix audit list --agent code-reviewer

# æ˜¾ç¤ºæ›´å¤šäº‹ä»¶
agix audit list -n 50
```

ç¤ºä¾‹è¾“å‡ºï¼š

```
æ—¶é—´æˆ³            Agent           ç±»å‹               è¯¦æƒ…
2026-02-21 10:15   code-reviewer   tool_call          è°ƒç”¨ï¼šread_file ï¼ˆå‚æ•°ï¼šsrc/main.goï¼‰
2026-02-21 10:16   docs-writer     tool_call          è°ƒç”¨ï¼šwrite_file ï¼ˆå‚æ•°ï¼šREADME.mdï¼‰
2026-02-21 10:17   security-scan   firewall_block     è§„åˆ™ï¼šblock_injection åŒ¹é…
2026-02-21 10:18   test-agent      response_redaction é‚®ç®±å·²è„±æ•ï¼š3 ä¸ªå‡ºç°æ¬¡æ•°
```

### äº‹ä»¶ç±»å‹

| ç±»å‹ | å«ä¹‰ | é£é™© |
|------|------|------|
| `tool_call` | å·¥å…·å·²æ‰§è¡Œ | ä¸­ç­‰ï¼ˆå·¥å…·å¯ä»¥ä¿®æ”¹ç³»ç»Ÿï¼‰ |
| `firewall_block` | æ³¨å…¥å°è¯•è¢«é˜»æ­¢ | é«˜ |
| `firewall_warn` | æ£€æµ‹åˆ°å¯ç–‘æ¨¡å¼ | ä¸­ç­‰ |
| `response_redaction` | è¾“å‡ºè¢«è„±æ• | ä½ |
| `budget_exceeded` | Agent è¾¾åˆ°é¢„ç®—ä¸Šé™ | ä½ |
| `rate_limit_exceeded` | Agent è¶…è¿‡é¢‘ç‡é™åˆ¶ | ä½ |

### å†…å®¹æ—¥å¿—

å½“ `content_log: true` æ—¶ï¼Œæ•è·è¯·æ±‚/å“åº”æ­£æ–‡ï¼š

```bash
agix audit list --type tool_call -n 1 | jq '.content'

# è¾“å‡ºï¼š
# {
#   "request": {
#     "model": "gpt-4o",
#     "messages": [...]
#   },
#   "response": {
#     "content": "..."
#   }
# }
```

**âš ï¸ å®‰å…¨è¯´æ˜**ï¼šå†…å®¹æ—¥å¿—å¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ã€‚ä¿æŠ¤å®ƒä»¬å¹¶è®¾ç½®ä¿ç•™ç­–ç•¥ã€‚

### çœŸå®ç¤ºä¾‹ï¼šè°ƒæŸ¥å·¥å…·è¯¯ç”¨

```bash
# 1. Agent å¼€å§‹æ„å¤–è°ƒç”¨ delete_file
# 2. å®¡æŸ¥å·¥å…·è°ƒç”¨å†å²
agix audit list --type tool_call --agent suspicious-agent -n 100

# 3. å¯»æ‰¾ delete_file è°ƒç”¨
# è¾“å‡ºæ˜¾ç¤ºï¼šAgent ç”¨æ•æ„Ÿè·¯å¾„è°ƒç”¨äº† delete_file

# 4. æ’¤é”€ Agent çš„å·¥å…·è®¿é—®æƒé™
vim ~/.agix/config.yaml
# ç¼–è¾‘ï¼šsuspicious-agent: deny: ["delete_file"]

# 5. é‡å¯ä»£ç†
agix start
```

## å¥åº·æ£€æŸ¥ï¼ˆagix doctorï¼‰

`agix doctor` å‘½ä»¤æ‰§è¡Œå…¨é¢è¯Šæ–­æ¥éªŒè¯é…ç½®å’Œè¿æ¥æ€§ã€‚

### è¿è¡Œ Doctor

```bash
agix doctor
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
é…ç½®å¥åº·æ£€æŸ¥
  âœ“ é…ç½®æ–‡ä»¶å­˜åœ¨äº ~/.agix/config.yaml
  âœ“ é…ç½®æ–‡ä»¶æƒé™æ­£ç¡®ï¼ˆ0600ï¼‰
  âœ“ æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨

API å¯†é’¥éªŒè¯
  âœ“ OpenAI API å¯†é’¥æœ‰æ•ˆ
  âœ“ Anthropic API å¯†é’¥æœ‰æ•ˆ
  âœ“ DeepSeek API å¯†é’¥æœ‰æ•ˆ

æ•°æ®åº“
  âœ“ SQLite æ•°æ®åº“å¯è®¿é—®
  âœ“ æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡
  âœ“ æ¨¡å¼ç‰ˆæœ¬ï¼š1

MCP æœåŠ¡å™¨
  âœ“ filesystem æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆpidï¼š12345ï¼‰
  âœ“ github æœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆpidï¼š12346ï¼‰

é¢„ç®—é…ç½®
  âœ“ æ‰€æœ‰é¢„ç®—é€»è¾‘ä¸€è‡´

é˜²ç«å¢™è§„åˆ™
  âœ“ æ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ç¼–è¯‘æˆåŠŸ

æ€»ä½“çŠ¶æ€ï¼šé€šè¿‡ï¼ˆæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼‰
```

### Doctor æ£€æŸ¥

Doctor æ‰§è¡Œè¿™äº›æ£€æŸ¥ï¼š

1. **é…ç½®æ–‡ä»¶æƒé™** â€” éªŒè¯ 0600ï¼ˆä»…é™æ‰€æœ‰è€…ï¼‰
2. **API å¯†é’¥æœ‰æ•ˆæ€§** â€” å¯¹æ¯ä¸ªæä¾›å•†è¿›è¡Œå®é™… API è°ƒç”¨
3. **æ•°æ®åº“è¿æ¥æ€§** â€” æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¥åº·
4. **MCP æœåŠ¡å™¨å¯åŠ¨** â€” éªŒè¯å·¥å…·å¯ä»¥æ‰§è¡Œ
5. **é¢„ç®—é€»è¾‘** â€” æ—¥ â‰¤ æœˆï¼Œç™¾åˆ†æ¯”åœ¨èŒƒå›´å†…
6. **é˜²ç«å¢™è§„åˆ™** â€” éªŒè¯æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
7. **æç¤ºè¯æ¨¡æ¿æœ‰æ•ˆæ€§** â€” æ£€æŸ¥æ¨¡æ¿è¯­æ³•

### å¸¸è§ Doctor é—®é¢˜

**é—®é¢˜**ï¼š"API å¯†é’¥æ— æ•ˆ"

```
åŸå› ï¼šå¯†é’¥è¿‡æœŸæˆ–æ ¼å¼é”™è¯¯
ä¿®å¤ï¼šæ›´æ–° config.yaml ä¸­çš„å¯†é’¥
$ vim ~/.agix/config.yaml
```

**é—®é¢˜**ï¼š"æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"

```
åŸå› ï¼šSQLite æ–‡ä»¶æŸå
ä¿®å¤ï¼šå¤‡ä»½å¹¶é‡å»º
$ cp ~/.agix/agix.db ~/.agix/agix.db.backup
$ rm ~/.agix/agix.db
# ä¸‹ä¸€ä¸ª agix å‘½ä»¤å°†é‡æ–°åˆ›å»ºå®ƒ
```

**é—®é¢˜**ï¼š"MCP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"

```
åŸå› ï¼šæ‰¾ä¸åˆ°å‘½ä»¤æˆ–è¯­æ³•é”™è¯¯
ä¿®å¤ï¼šéªŒè¯é…ç½®ä¸­çš„å‘½ä»¤
$ npm list -g @modelcontextprotocol/server-filesystem
# å¦‚æœç¼ºå°‘ï¼Œè¯·å®‰è£…
$ npm install -g @modelcontextprotocol/server-filesystem
```

## æŒ‡æ ‡ä»ªè¡¨æ¿

Web ä»ªè¡¨æ¿æä¾›æˆæœ¬å’Œé¢„ç®—çš„å®æ—¶å¯è§†åŒ–ã€‚

### å¯ç”¨ä»ªè¡¨æ¿

```yaml
dashboard:
  enabled: true                    # åœ¨ /dashboard/ æä¾›
```

### è®¿é—®ä»ªè¡¨æ¿

```
http://localhost:8080/dashboard/
```

### ä»ªè¡¨æ¿åŠŸèƒ½

1. **æˆæœ¬æ¦‚è§ˆ**
   - ä»Šæ—¥æ€»æˆæœ¬
   - æ¯æ—¥è¶‹åŠ¿ï¼ˆæœ€å 30 å¤©ï¼‰
   - æŒ‰ Agent çš„æˆæœ¬ï¼ˆé¥¼å›¾ï¼‰
   - æŒ‰æ¨¡å‹çš„æˆæœ¬ï¼ˆæŸ±çŠ¶å›¾ï¼‰

2. **é¢„ç®—ç›‘æ§**
   - æ¯ä¸ª Agent çš„é¢„ç®—çŠ¶æ€
   - å¯è§†åŒ–è¿›åº¦æ¡ï¼ˆ0-100%ï¼‰
   - å‰©ä½™é¢„ç®—ï¼ˆç¾å…ƒï¼‰
   - é‡ç½®å‰çš„å¤©æ•°

3. **å®æ—¶æŒ‡æ ‡**
   - å½“å‰è¯·æ±‚ç‡
   - å¹³å‡å“åº”æ—¶é—´
   - ç¼“å­˜å‘½ä¸­ç‡
   - Token æ•ˆç‡

4. **å‘Šè­¦**
   - æ¥è¿‘é¢„ç®—ä¸Šé™çš„ Agent
   - æœ€è¿‘é˜²ç«å¢™é˜»æ­¢
   - å¤±è´¥çš„è¯·æ±‚

### API ç«¯ç‚¹ï¼ˆç”¨äºè‡ªå®šä¹‰ä»ªè¡¨æ¿ï¼‰

```bash
# è·å–èšåˆç»Ÿè®¡
curl http://localhost:8080/api/stats

# è·å–æŒ‰ Agent çš„ç»Ÿè®¡
curl http://localhost:8080/api/agents

# è·å–é¢„ç®—ä¿¡æ¯
curl http://localhost:8080/api/budgets

# è·å–æ¯æ—¥æˆæœ¬
curl http://localhost:8080/api/costs/daily

# è·å–æœ€è¿‘æ—¥å¿—
curl http://localhost:8080/api/logs
```

ç¤ºä¾‹ JSON å“åº”ï¼š

```json
{
  "stats": {
    "total_requests": 1245,
    "total_cost_usd": 18.50,
    "total_input_tokens": 125000,
    "total_output_tokens": 45000,
    "avg_cost_per_request": 0.015,
    "cache_hit_rate": 0.23
  },
  "by_agent": [
    {
      "agent": "code-reviewer",
      "requests": 450,
      "cost": 12.30,
      "cache_hits": 120
    },
    {
      "agent": "docs-writer",
      "requests": 300,
      "cost": 4.20,
      "cache_hits": 45
    }
  ]
}
```

## å¯è§‚æµ‹æ€§ç®¡é“

### çœŸå®ç›‘æ§è®¾ç½®

```yaml
# 1. å¯ç”¨æ‰€æœ‰å¯è§‚æµ‹æ€§åŠŸèƒ½
tracing:
  enabled: true
  sample_rate: 0.5              # è®°å½• 50% çš„è¯·æ±‚

audit:
  enabled: true
  content_log: false            # ä¸è®°å½•å®Œæ•´æ­£æ–‡ï¼ˆéšç§ï¼‰

dashboard:
  enabled: true

# 2. è®¾ç½®å®šæœŸå®¡æŸ¥
# æ—©æ™¨ï¼š
#   agix stats --period 1d      # æ˜¨å¤©çš„æˆæœ¬
#   agix trace list             # æ£€æŸ¥æ…¢è¯·æ±‚
#
# æ¯å‘¨ï¼š
#   agix audit list -n 1000     # å®¡æŸ¥å®‰å…¨äº‹ä»¶
#   agix stats --group-by agent # Agent æˆæœ¬åˆ†æ
#
# æ¯æœˆï¼š
#   agix export --format csv --period 2026-02  # å¯¼å‡ºä¾›æŠ¥å‘Š
#   agix doctor                 # éªŒè¯ç³»ç»Ÿå¥åº·
```

### å‘Šè­¦æ¨¡å¼

```bash
#!/bin/bash
# é€šè¿‡ cron æ¯æ—¥è¿è¡Œ

ALERT_EMAIL="ops@example.com"

# æ£€æŸ¥ä»»ä½• Agent æ˜¯å¦è¶…å‡ºæ¯æ—¥é¢„ç®—çš„ 80%
HIGH_SPEND=$(agix budget | grep "%" | grep -E "[8-9][0-9]%|100%")

if [ ! -z "$HIGH_SPEND" ]; then
  echo "âš ï¸  æ£€æµ‹åˆ°é«˜æ”¯å‡ºï¼š" > /tmp/alert.txt
  echo "$HIGH_SPEND" >> /tmp/alert.txt
  mail -s "agixï¼šé¢„ç®—å‘Šè­¦" $ALERT_EMAIL < /tmp/alert.txt
fi

# æ£€æŸ¥é˜²ç«å¢™é˜»æ­¢
BLOCKS=$(agix audit list --type firewall_block -n 10)
if [ ! -z "$BLOCKS" ]; then
  echo "ğŸš¨ æ£€æµ‹åˆ°é˜²ç«å¢™é˜»æ­¢ï¼š" > /tmp/alert.txt
  echo "$BLOCKS" >> /tmp/alert.txt
  mail -s "agixï¼šé˜²ç«å¢™å‘Šè­¦" $ALERT_EMAIL < /tmp/alert.txt
fi
```

## æœ€ä½³å®è·µ

1. **å¯ç”¨è¿½è¸ªè¿›è¡Œè°ƒè¯•** â€” å¸®åŠ©è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
2. **ç›‘æ§é˜²ç«å¢™é˜»æ­¢** â€” æ¯æ—¥å®¡æŸ¥å®¡è®¡æ—¥å¿—ä»¥å‘ç°å¯ç–‘æ´»åŠ¨
3. **åœ¨éƒ¨ç½²å‰è¿è¡Œ doctor** â€” éªŒè¯æ‰€æœ‰ä¾èµ–é¡¹å’Œé…ç½®
4. **æ¯å¤©æŸ¥çœ‹ä»ªè¡¨æ¿** â€” æ—©æœŸå‘ç°å¤±æ§æ”¯å‡º
5. **è®¾ç½®å‘Šè­¦** â€” é¢„ç®—/å®‰å…¨äº‹ä»¶çš„è‡ªåŠ¨é€šçŸ¥
6. **åœ¨ç”Ÿäº§ä¸­é‡‡æ ·è¿½è¸ª** â€” ä½¿ç”¨ `sample_rate: 0.1-0.5` æ¥å‡å°‘ç£ç›˜ä½¿ç”¨
7. **ä¿ç•™å®¡è®¡æ—¥å¿—** â€” ä¸ºåˆè§„æ€§ä¿ç•™ 90+ å¤©
8. **æœˆåº¦æ•°æ®å¯¼å‡º** â€” ç”¨äºè´¢åŠ¡/æŠ¥å‘Šçš„ CSV å¯¼å‡º
